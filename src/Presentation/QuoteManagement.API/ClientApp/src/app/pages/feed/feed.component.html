<div class="feed-container">
  <div class="card mb-4">
    <div class="flex justify-between align-items-center mb-4">
      <div class="font-semibold text-2xl">📚 Alıntılar</div>
      <p-button 
        label="Alıntı Ekle" 
        icon="pi pi-plus" 
        (click)="showBookSearchModal = true"
        styleClass="add-quote-btn"
        size="small">
      </p-button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading">
    <div class="card mb-4" *ngFor="let item of [1, 2, 3]">
      <div class="font-semibold text-xl mb-4">Quote Loading...</div>
      <div class="rounded-border border border-surface p-4">
        <div class="flex mb-4">
          <p-skeleton shape="circle" size="4rem" styleClass="mr-3"></p-skeleton>
          <div class="flex-1">
            <p-skeleton width="10rem" styleClass="mb-2"></p-skeleton>
            <p-skeleton width="5rem" styleClass="mb-2"></p-skeleton>
            <p-skeleton height=".5rem"></p-skeleton>
          </div>
        </div>
        <p-skeleton width="100%" height="80px" styleClass="mb-4"></p-skeleton>
        <div class="flex justify-between">
          <p-skeleton width="6rem" height="2rem"></p-skeleton>
          <p-skeleton width="4rem" height="2rem"></p-skeleton>
        </div>
      </div>
    </div>
  </div>

  <!-- Quotes Feed -->
  <div *ngIf="!loading">
    <div class="card mb-4" *ngFor="let quote of quotes; let i = index">
      <div class="flex align-items-center mb-3">
        <i class="pi pi-quote-left text-primary mr-2"></i>
        <span class="font-semibold text-lg">Alıntı</span>
      </div>

      <div class="border border-surface rounded-border p-4">
        <!-- User Info -->
        <div class="flex align-items-center mb-4">
          <p-avatar [image]="quote.userAvatar" size="large" shape="circle" styleClass="mr-3"> </p-avatar>
          <div>
            <div class="font-semibold text-lg">{{ quote.userName }}</div>
            <div class="text-sm text-500 mb-1">{{ quote.userNickname }}</div>
            <div class="text-xs text-400">{{ quote.datePosted | date: 'short' }}</div>
          </div>
        </div>
        <!-- Quote Content -->
        <div class="quote-content mb-4">
          <blockquote class="border-left-3 border-primary pl-4 italic text-lg line-height-3 my-4 mb-6">"{{ getDisplayedQuoteText(quote) }}"</blockquote>

          <!-- Read More/Less Button for Long Quotes -->
          <div class="text-center mb-3" *ngIf="isQuoteLong(quote.quoteText)">
            <p-button
              [label]="isQuoteExpanded(quote.id) ? 'Show less' : 'Read more'"
              [icon]="isQuoteExpanded(quote.id) ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
              severity="secondary"
              size="small"
              text
              (click)="toggleQuoteExpansion(quote.id)"
              styleClass="quote-expand-btn"
            >
            </p-button>
          </div>

          <div class="flex flex-wrap gap-2 mb-3 mt-4">
            <p-tag [value]="'📖 ' + quote.bookName" severity="info" styleClass="text-sm"> </p-tag>
            <p-tag [value]="'✍️ ' + quote.author" severity="secondary" styleClass="text-sm"> </p-tag>
            <p-tag [value]="quote.genre" severity="success" styleClass="text-sm" *ngIf="quote.genre"> </p-tag>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between align-items-center">
          <div class="flex gap-2">
            <p-button icon="pi pi-heart" [label]="quote.likes.toString()" severity="secondary" size="small" [outlined]="!quote.isLiked" (click)="toggleLike(i)" styleClass="quote-action-btn"> </p-button>
            <p-button icon="pi pi-comment" [label]="quote.comments.toString()" severity="secondary" size="small" outlined styleClass="quote-action-btn"> </p-button>
          </div>

          <div class="flex gap-2">
            <p-button icon="pi pi-copy" severity="secondary" size="small" outlined (click)="copyQuote(quote.quoteText)" pTooltip="Copy quote" tooltipPosition="top"> </p-button>
            <p-button icon="pi pi-bookmark" severity="secondary" size="small" [outlined]="!quote.isBookmarked" (click)="toggleBookmark(i)" styleClass="quote-action-btn"> </p-button>
            <p-button icon="pi pi-share-alt" severity="secondary" size="small" outlined (click)="shareQuote(quote)" pTooltip="Share quote" tooltipPosition="top"> </p-button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && quotes.length === 0" class="card text-center p-6">
    <i class="pi pi-book text-6xl text-300 mb-4"></i>
    <h3 class="text-xl font-semibold mb-2">No quotes yet</h3>
    <p class="text-500">Start sharing your favorite book quotes!</p>
  </div>
</div>

<!-- Book Search Modal -->
<p-dialog 
  header="Kitap Seç" 
  [(visible)]="showBookSearchModal" 
  [modal]="true" 
  [closable]="true"
  [dismissableMask]="true"
  [style]="{width: '600px'}"
  styleClass="book-search-modal">
  
  <div class="flex flex-column gap-4">
    <!-- Search Input -->
    <div class="flex flex-column gap-2">
      <label for="bookSearch" class="font-semibold">Kitap Ara</label>
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input 
          pInputText 
          id="bookSearch"
          [(ngModel)]="bookSearchQuery" 
          (input)="searchBooks()"
          placeholder="Kitap adı veya yazar ara..."
          class="w-full"
          autocomplete="off">
      </span>
    </div>

    <!-- Loading State -->
    <div *ngIf="searchingBooks" class="text-center py-4">
      <p-progressSpinner strokeWidth="4" [style]="{width: '50px', height: '50px'}"></p-progressSpinner>
      <div class="mt-2">Kitaplar aranıyor...</div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!searchingBooks && bookSearchQuery && searchResults.length === 0" class="text-center py-4">
      <i class="pi pi-search text-4xl text-300 mb-3"></i>
      <div class="text-500">Arama sonucu bulunamadı</div>
      <div class="text-400 text-sm">Farklı anahtar kelimeler deneyin</div>
    </div>

    <!-- Search Results -->
    <div *ngIf="!searchingBooks && searchResults.length > 0" class="search-results max-h-20rem overflow-y-auto">
      <div class="text-sm text-500 mb-3">{{searchResults.length}} sonuç bulundu</div>
      <div class="flex flex-column gap-2">
        <div 
          *ngFor="let book of searchResults" 
          class="book-result-item p-3 border-1 border-surface-300 border-round cursor-pointer hover:bg-surface-50 transition-colors transition-duration-150"
          (click)="selectBookAndProceed(book)"
          [class.selected]="selectedBook?.id === book.id">
          
          <div class="flex align-items-center gap-3">
            <div class="book-cover-mini">
              <img 
                [src]="book.coverImageUrl || '/demo/images/ecommerce/blue-book.jpg'" 
                [alt]="book.title"
                class="w-full h-full object-cover border-round"
                (error)="onBookCoverError($event)">
            </div>
            
            <div class="flex-1">
              <div class="font-semibold text-900 mb-1 line-height-3">{{book.title}}</div>
              <div class="text-600 text-sm mb-1">{{book.author || 'Bilinmeyen Yazar'}}</div>
              <div class="text-400 text-xs" *ngIf="book.isbn">ISBN: {{book.isbn}}</div>
              <p-tag 
                [value]="book.quoteCount + ' alıntı'" 
                severity="info" 
                styleClass="text-xs mt-1">
              </p-tag>
            </div>
            
            <i class="pi pi-chevron-right text-400"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Initial State -->
    <div *ngIf="!bookSearchQuery && !searchingBooks" class="text-center py-6">
      <i class="pi pi-book text-4xl text-300 mb-3"></i>
      <div class="text-500 mb-2">Alıntı eklemek için kitap arayın</div>
      <div class="text-400 text-sm">Kitap adı veya yazar adı ile arama yapabilirsiniz</div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button 
      label="İptal" 
      icon="pi pi-times" 
      (click)="closeBookSearchModal()"
      text 
      severity="secondary">
    </p-button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
